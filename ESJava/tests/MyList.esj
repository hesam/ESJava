import polyglot.ext.esj.primitives.*;
import polyglot.ext.esj.tologic.*;

public class MyList extends ESJList
{

    /*@
        // CLASS INVARIANTS	
    @*/

    public MyList() {
	this(false, 0);
    }

    public MyList(boolean isaPrime, int fixedSize) {
	super(isaPrime, fixedSize);
	this.rel_log = new LogRelation("MyList" , Integer.class, Integer.class, true, isaPrime, fixedSize);
	this.prime = isaPrime ? null : newPrime();

    }

    public MyList newPrime() {
	return new MyList(true, size());
    }


    public MyList prime() { return this; }
    public MyList prime_log() { return (MyList) prime; }

    // Constructor
    //none..

    // PREDICATE METHODS
    
    predicate public boolean isSorted() {
	all i : indices().allButLast() | get(i) <= get(i+1)
	}

    
    predicate public boolean isPermutationOf(ESJList l) {
	all i : int | count(i) == l.count(i)
	    }

    ensured public void bubbleSort() 
	ensures (this.prime().isPermutationOf(this) && 
		 this.prime().isSorted()) {
	System.out.println();

	//int z = 1/0; // <-- TEST: RUN TIME ERROR INTRODUCED
	for(int i=size()-1;i>0;i--) {
	    //for(int i=size()-2;i>0;i--) { // <-- TEST: ASSERTION VIOLATION BUG INTRODUCED
	    for(int j=0;j<i;j++) {
		if (get(j).intValue() > get(i).intValue()) {
		    Integer t = get(i);
		    remove(i);
		    add(i,get(j));
		    remove(j);
		    add(j,t);
		}
	    }
	}

    }

    
    public static void main(String[] args) {

        MyList ta = new MyList();	
        MyList tb = new MyList();
	int [] a = {1,2,3,4,4,5};
	int [] b = {4,3,2,4,5,1};
	for(int i=0;i<a.length;i++) {
	    ta.add(new Integer(a[i]));
	    tb.add(new Integer(b[i]));
	}
	System.out.print("A=");
        ta.println();
	System.out.print("A sorted: ");
	System.out.println(ta.isSorted());
	System.out.print("B=");
        tb.println();
	System.out.print("B sorted: ");
	System.out.println(tb.isSorted());
	System.out.print("permutations: ");
	System.out.println(ta.isPermutationOf(tb));
	System.out.println("sorting second...");
	tb.bubbleSort();
	System.out.print("B=");
	System.out.println(tb);
	System.out.print("now B sorted: ");
	System.out.println(tb.isSorted());


    }

}

